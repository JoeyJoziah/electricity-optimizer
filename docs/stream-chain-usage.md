# Stream-Chain Usage Guide

> Generated by SPARC Docs-Writer Mode | 2026-02-26

## Quick Start

```bash
# List available pipelines
scripts/stream-chain-run.sh --list

# Preview what a pipeline will do (no execution)
scripts/stream-chain-run.sh test --dry-run

# Run a pipeline
scripts/stream-chain-run.sh test

# Run in background
scripts/stream-chain-run.sh security --bg

# Verbose output (shows full CLI command)
scripts/stream-chain-run.sh analysis --verbose
```

## CLI Reference

```
scripts/stream-chain-run.sh <pipeline> [flags]
scripts/stream-chain-run.sh --list
```

| Flag | Effect |
|------|--------|
| `--list` | Print all pipelines with descriptions, step counts, and timeouts |
| `--dry-run` | Show pipeline prompts without executing |
| `--bg` | Run in background (prints PID) |
| `--verbose` | Print the full `npx claude-flow` command before execution |

## Pipelines

### `test` — Full Test Suite + Gap Analysis
**4 steps, 120s/step**

Runs all three test layers sequentially and produces a coverage gap report:
1. Backend tests (`.venv/bin/python -m pytest backend/tests/`) — baseline: 1253
2. Frontend tests (`npx jest --ci`) — baseline: 834 across 52 suites
3. ML tests (`.venv/bin/python -m pytest ml/tests/`) — baseline: 257 (41 skipped)
4. Gap report — identifies untested endpoints, components, and services

```bash
scripts/stream-chain-run.sh test
```

### `security` — OWASP Audit + Dependency Scan
**4 steps, 60s/step**

Comprehensive security analysis:
1. OWASP Top 10 audit (SQL injection, XSS, auth bypass, CSRF)
2. Dependency vulnerability scan (`pip audit` + `npm audit`)
3. Secrets/credential scan across `.py`, `.ts`, `.tsx` files
4. Adversarial test suite execution (42 tests)

```bash
scripts/stream-chain-run.sh security
```

### `refactor` — Code Complexity + Tech Debt
**3 steps, 45s/step**

Identifies refactoring opportunities:
1. Complexity scan — functions > 50 lines, cyclomatic complexity > 10, components > 200 lines
2. Tech debt inventory — TODOs, deprecated APIs, dead code, inconsistencies
3. Prioritized refactoring plan grouped by effort (quick wins / medium / major)

```bash
scripts/stream-chain-run.sh refactor
```

### `feature-tdd` — TDD Development Chain
**4 steps, 90s/step**

Full test-driven development cycle:
1. Write technical specification from feature description
2. Create failing test cases (pytest + Jest patterns)
3. Implement code to pass tests
4. Run full suite for regressions, then review for refactoring opportunities

```bash
scripts/stream-chain-run.sh feature-tdd
```

### `deploy-check` — Pre-Deployment Readiness
**4 steps, 60s/step**

Pre-deploy verification gate:
1. Test gate — all suites must pass with zero failures
2. Config check — render.yaml env vars, Dockerfile, CSP/HSTS headers, Swagger disabled
3. Migration check — sequential numbering, conftest.py field sync, no stale references
4. Production readiness — no .env in git, no debug code, CORS, rate limiting, go/no-go

```bash
scripts/stream-chain-run.sh deploy-check
```

### `analysis` — Architecture Deep Dive
**3 steps, 45s/step**

Comprehensive architecture analysis:
1. Architecture map — API routers, service layer, frontend routes, external integrations
2. Dependency analysis — import chains, circular deps, coupling hotspots, prop drilling
3. Technical debt report — risks, bottlenecks, test debt, dependency risks with timeline

```bash
scripts/stream-chain-run.sh analysis
```

## Output Files

After each run, two files are created in `.claude-flow/memory/stream-chain/runs/`:

**Result summary** (`<pipeline>-<YYYYMMDD-HHMMSS>.json`):
```json
{
  "runId": "test-20260226-143022",
  "pipeline": "test",
  "steps": 4,
  "timeout": 120,
  "exitCode": 0,
  "durationSeconds": 312,
  "status": "success",
  "timestamp": "2026-02-26T19:30:22Z",
  "outputLog": "/Users/devinmcgrath/projects/electricity-optimizer/.claude-flow/memory/stream-chain/runs/test-20260226-143022-output.log"
}
```

**Raw output log** (`<pipeline>-<YYYYMMDD-HHMMSS>-output.log`):
Full stdout/stderr from the `claude-flow stream-chain` CLI execution.

## Loki Event Integration

Every completed run (success or failure) emits a `task_complete` event to `.loki/events/pending/`:

```json
{
  "type": "task_complete",
  "task": "stream-chain/success: security (4 steps, 187s)",
  "source": "stream-chain",
  "pipeline": "security",
  "runId": "security-20260226-143022",
  "status": "success",
  "durationSeconds": 187,
  "timestamp": "2026-02-26T19:30:22Z"
}
```

The `task` field is read by `loki-event-sync.sh`'s `handle_task_complete` handler for board sync logging.

The existing `loki-event-sync.sh` hook processes these events, triggering GitHub Projects and Notion board sync.

## Prerequisites

- `npx claude-flow` must be available (claude-flow MCP server registered in `.mcp.json`)
- `python3` on PATH (used for JSON parsing)
- `.claude-flow/config.json` must exist with valid pipeline definitions
- `.venv/` activated for backend/ML test pipelines
- `node_modules/` installed in `frontend/` for frontend test pipelines

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| `Config not found` | Missing `.claude-flow/config.json` | Re-run setup or restore from backup |
| `Pipeline not found` | Typo in pipeline name | Run `--list` to see available names |
| `npx claude-flow` fails | claude-flow not installed | `npm install -g claude-flow@latest` |
| Tests timeout | Step timeout too low | Increase `timeout` in config.json |
| No Loki event | `.loki/events/pending/` missing | `mkdir -p .loki/events/pending` |
