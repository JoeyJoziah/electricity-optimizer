name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # Detect what changed to skip irrelevant jobs
  # ===========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      pull-requests: read

    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      ml: ${{ steps.filter.outputs.ml }}
      docker: ${{ steps.filter.outputs.docker }}
      workflows: ${{ steps.filter.outputs.workflows }}

    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'requirements*.txt'
            frontend:
              - 'frontend/**'
            ml:
              - 'ml/**'
            docker:
              - '**/Dockerfile'
              - 'docker-compose*.yml'
            workflows:
              - '.github/**'

  # ===========================================================================
  # Backend: lint + tests (reusable workflow)
  # ===========================================================================
  backend-lint:
    name: Backend Lint
    needs: changes
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          working-directory: backend

      - name: Install linting tools
        run: pip install black isort flake8 mypy

      - name: Check formatting with Black
        run: cd backend && black --check .

      - name: Check import sorting with isort
        run: cd backend && isort --check-only .

      - name: Lint with flake8
        run: |
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Type check with mypy
        run: cd backend && mypy . --ignore-missing-imports --no-strict-optional
        continue-on-error: true

  backend-tests:
    name: Backend Tests
    needs: changes
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.workflows == 'true'
    uses: ./.github/workflows/_backend-tests.yml
    with:
      coverage: true
      upload-codecov: true
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ===========================================================================
  # ML Tests
  # ===========================================================================
  ml-tests:
    name: ML Tests
    needs: changes
    if: needs.changes.outputs.ml == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          working-directory: ml

      - name: Install test dependencies
        run: pip install pytest pytest-cov

      - name: Run ML tests with coverage
        run: |
          cd ml
          pytest --cov=. --cov-report=xml --cov-report=term-missing -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./ml/coverage.xml
          flags: ml
          name: ml-coverage
          fail_ci_if_error: false

  # ===========================================================================
  # Frontend: lint + tests + build
  # ===========================================================================
  frontend-tests:
    name: Frontend Tests
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node-env

      - name: Lint with ESLint
        run: cd frontend && npm run lint

      - name: Run unit tests with coverage
        run: cd frontend && npm test -- --coverage --watchAll=false --passWithNoTests

      - name: Build Next.js application
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: cd frontend && npm run build

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./frontend/coverage
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

  # ===========================================================================
  # Security Scan (blocking — no continue-on-error)
  # ===========================================================================
  security-scan:
    name: Security Scan
    needs: changes
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' || needs.changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run Bandit (high-severity only)
        run: |
          pip install bandit
          cd backend
          bandit -r . -f json -o ../bandit-report.json -ll --severity-level high || {
            echo "::warning::Bandit found high-severity issues"
          }

      - name: Run Bandit on ML
        run: |
          cd ml
          bandit -r . -f json -o ../bandit-report-ml.json -ll --severity-level high || {
            echo "::warning::Bandit found high-severity ML issues"
          }

      - name: Run npm audit (critical only)
        run: |
          cd frontend
          npm audit --audit-level=critical || {
            echo "::warning::npm audit found critical vulnerabilities"
          }

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            bandit-report-ml.json

  # ===========================================================================
  # Docker Build Validation (no push — tests must pass first)
  # ===========================================================================
  docker-build:
    name: Docker Build Test
    needs: [changes, backend-tests, frontend-tests]
    if: |
      always() &&
      (needs.changes.outputs.docker == 'true' || needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true') &&
      (needs.backend-tests.result == 'success' || needs.backend-tests.result == 'skipped') &&
      (needs.frontend-tests.result == 'success' || needs.frontend-tests.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: electricity-optimizer-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: electricity-optimizer-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production
          build-args: |
            NEXT_PUBLIC_API_URL=http://backend:8000
