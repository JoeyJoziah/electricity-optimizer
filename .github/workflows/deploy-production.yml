name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository }}/backend
  FRONTEND_IMAGE: ${{ github.repository }}/frontend

jobs:
  # ===========================================================================
  # Validate Release
  # ===========================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

  # ===========================================================================
  # Run Tests (reusable workflow)
  # ===========================================================================
  test:
    name: Run Tests
    needs: [validate]
    if: github.event.inputs.skip_tests != 'true'
    uses: ./.github/workflows/_backend-tests.yml
    with:
      coverage: false
      upload-codecov: false

  # ===========================================================================
  # Security Gate (blocking — must pass before deploy)
  # ===========================================================================
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [validate]
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Bandit high-severity check
        run: |
          pip install bandit
          cd backend
          # Fail on high-severity issues (exit code non-zero)
          bandit -r . -ll --severity-level high -f txt
          echo "Backend security scan passed"

      - name: npm audit critical check
        run: |
          cd frontend
          npm audit --audit-level=critical
          echo "Frontend security audit passed"

  # ===========================================================================
  # Build and Push Images (archival — Render builds from repo)
  # ===========================================================================
  build-backend:
    name: Build Backend Image
    needs: [validate, test, security-gate]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && needs.security-gate.result == 'success'
    uses: ./.github/workflows/_docker-build-push.yml
    with:
      context: ./backend
      dockerfile: ./backend/Dockerfile
      image-name: ghcr.io/${{ github.repository }}/backend
      tags: |
        type=raw,value=latest
        type=raw,value=${{ needs.validate.outputs.version }}
        type=sha,prefix=
      push: true

  build-frontend:
    name: Build Frontend Image
    needs: [validate, test, security-gate]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && needs.security-gate.result == 'success'
    uses: ./.github/workflows/_docker-build-push.yml
    with:
      context: ./frontend
      dockerfile: ./frontend/Dockerfile
      image-name: ghcr.io/${{ github.repository }}/frontend
      tags: |
        type=raw,value=latest
        type=raw,value=${{ needs.validate.outputs.version }}
        type=sha,prefix=
      build-args: NEXT_PUBLIC_API_URL=${{ vars.PROD_API_URL }}
      push: true

  # ===========================================================================
  # Deploy to Render
  # ===========================================================================
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [validate, build-backend, build-frontend]
    timeout-minutes: 15
    environment:
      name: production
      url: https://electricity-optimizer.com

    steps:
      - name: Trigger Render backend deploy
        run: |
          echo "Triggering Render backend deploy..."
          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}" || {
            echo "::error::Failed to trigger backend deploy hook"
            exit 1
          }
          echo "Backend deploy hook triggered"

      - name: Trigger Render frontend deploy
        run: |
          echo "Triggering Render frontend deploy..."
          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}" || {
            echo "::error::Failed to trigger frontend deploy hook"
            exit 1
          }
          echo "Frontend deploy hook triggered"

  # ===========================================================================
  # Smoke Tests with Self-Healing
  # ===========================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Wait for backend
        uses: ./.github/actions/wait-for-service
        with:
          url: ${{ secrets.PROD_API_URL }}/health
          timeout: '300'
          interval: '15'

      - name: Wait for frontend
        uses: ./.github/actions/wait-for-service
        with:
          url: ${{ secrets.PROD_FRONTEND_URL }}
          timeout: '300'
          interval: '15'

      - name: Verify API endpoints
        id: smoke
        run: |
          FAILURES=0
          for endpoint in /health /api/v1/prices/current; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PROD_API_URL }}${endpoint}" 2>/dev/null) || STATUS="000"
            if [ "$STATUS" != "200" ] && [ "$STATUS" != "401" ]; then
              echo "FAIL: ${endpoint} returned ${STATUS}"
              FAILURES=$((FAILURES + 1))
            else
              echo "OK: ${endpoint} returned ${STATUS}"
            fi
          done
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT

      - name: Auto-retry deploy on failure
        if: steps.smoke.outputs.failures != '0'
        run: |
          echo "::warning::Smoke tests failed (${{ steps.smoke.outputs.failures }} failures). Triggering re-deploy..."
          curl -s -X POST "${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}" || true
          curl -s -X POST "${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}" || true

      - name: Wait for re-deploy
        if: steps.smoke.outputs.failures != '0'
        uses: ./.github/actions/wait-for-service
        with:
          url: ${{ secrets.PROD_API_URL }}/health
          timeout: '300'
          interval: '15'

      - name: Final verification
        if: steps.smoke.outputs.failures != '0'
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PROD_API_URL }}/health" 2>/dev/null) || STATUS="000"
          if [ "$STATUS" != "200" ]; then
            echo "::error::Backend still unhealthy after re-deploy (HTTP $STATUS)"
            exit 1
          fi
          echo "Backend recovered after re-deploy"

  # ===========================================================================
  # Rollback on Failure
  # ===========================================================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [smoke-tests]
    if: failure()
    timeout-minutes: 5

    steps:
      - name: Notify deployment failure
        run: |
          echo "::error::Production deployment failed and smoke tests did not recover"
          echo "Manual investigation required"
          echo "Version: ${{ needs.validate.outputs.version }}"

  # ===========================================================================
  # Notify Success
  # ===========================================================================
  notify-success:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [validate, smoke-tests]
    if: success()
    timeout-minutes: 5

    steps:
      - name: Production deployment successful
        run: |
          echo "Production deployment successful!"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo "URL: https://electricity-optimizer.com"
